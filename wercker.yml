box: romani/sonarqube-maven-git

build:
  steps:
  - script:
      name: setup mvn local repo
      code: |-
        export MAVEN_OPTS="-Dmaven.repo.local=${WERCKER_CACHE_DIR}"
        mvn -version
        echo "------"
        du -hs ${WERCKER_CACHE_DIR}
        echo "------"
        du -hs ${WERCKER_CACHE_DIR}/* | sort -h

  # Build Checkstyle
  - script:
      name: Package plugin, install to sonar
      code: >
        cd sonar-checkstyle
        && mvn package
        && cp checkstyle-sonar-plugin/target/checkstyle-sonar-plugin-3.6-SNAPSHOT.jar ../extensions/plugins/
        && curl -X POST http://localhost:9000/api/system/restart -u admin:admin
        && sleep 20
        && mvn sonar:sonar

  # Cleanup
  - script:
      name: Cleanup maven local repo
      code:  |-
        find ${WERCKER_CACHE_DIR} -type d -name "*SNAPSHOT" -ls -exec rm -rf {} +
        echo "------"
        du -hs ${WERCKER_CACHE_DIR}
        echo "------"
        du -hs ${WERCKER_CACHE_DIR}/* | sort -h
        echo "------"
        du -hs * | sort -h

